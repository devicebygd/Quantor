<%- include('layout-start') %>

<div class="admin-section">
    <div class="admin-section-header">
        <h2>Mesajlar</h2>
    </div>

    <% if (messages.length === 0) { %>
    <p class="text-muted" style="padding: 2rem; text-align: center;">Hələ ki mesaj yoxdur.</p>
    <% } else { %>
    <div class="admin-table-wrapper">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Tarix</th>
                    <th>Ad</th>
                    <th>E-poçt</th>
                    <th>Mövzu</th>
                    <th>Status</th>
                    <th>Əməliyyatlar</th>
                </tr>
            </thead>
            <tbody>
                <% messages.forEach(function(m) { %>
                <tr class="<%= !m.read ? 'unread-row' : '' %>">
                    <td><%= new Date(m.date).toLocaleDateString('az-AZ') %></td>
                    <td><strong><%= m.name %></strong></td>
                    <td><%= m.email %></td>
                    <td><%= m.subject || '—' %></td>
                    <td><span class="badge <%= m.read ? 'badge-gray' : 'badge-blue' %>"><%= m.read ? 'Oxunub' : 'Yeni' %></span></td>
                    <td class="table-actions">
                        <button class="btn btn-sm btn-outline" onclick='showMessage(<%- JSON.stringify(m.name) %>, <%- JSON.stringify(m.email) %>, <%- JSON.stringify(m.phone || "—") %>, <%- JSON.stringify(m.subject || "—") %>, <%- JSON.stringify(m.message) %>, <%- JSON.stringify(m.date) %>)'>Oxu</button>
                        <% if (!m.read) { %>
                        <form action="/admin/messages/read/<%= m.id %>" method="POST" style="display:inline">
                            <button type="submit" class="btn btn-sm btn-outline">Oxundu</button>
                        </form>
                        <% } %>
                        <form action="/admin/messages/delete/<%= m.id %>" method="POST" style="display:inline" onsubmit="return confirm('Silmək istədiyinizdən əminsiniz?')">
                            <button type="submit" class="btn btn-sm btn-danger">Sil</button>
                        </form>
                    </td>
                </tr>
                <% }); %>
            </tbody>
        </table>
    </div>
    <% } %>
</div>

<!-- Message Modal -->
<div class="modal" id="messageModal">
    <div class="modal-overlay" onclick="this.parentElement.classList.remove('open')"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="msgName"></h3>
            <button class="modal-close" onclick="this.closest('.modal').classList.remove('open')">&times;</button>
        </div>
        <div class="message-details">
            <p><strong>E-poçt:</strong> <span id="msgEmail"></span></p>
            <p><strong>Telefon:</strong> <span id="msgPhone"></span></p>
            <p><strong>Mövzu:</strong> <span id="msgSubject"></span></p>
            <p><strong>Tarix:</strong> <span id="msgDate"></span></p>
            <hr>
            <p id="msgBody" style="white-space: pre-wrap;"></p>
        </div>
    </div>
</div>

<script>
function showMessage(name, email, phone, subject, body, date) {
    document.getElementById('msgName').textContent = name;
    document.getElementById('msgEmail').textContent = email;
    document.getElementById('msgPhone').textContent = phone;
    document.getElementById('msgSubject').textContent = subject;
    document.getElementById('msgBody').textContent = body;
    document.getElementById('msgDate').textContent = new Date(date).toLocaleString('az-AZ');
    document.getElementById('messageModal').classList.add('open');
}
</script>

<%- include('layout-end') %>
